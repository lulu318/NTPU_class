---
title: "HW2 品質管制圖分析"
author: "711378912 蔡宜諠"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(qcc)
library(pbcc)
```

##  [ 第1大題 ]

###  > 查看資料

```{r}
df_t62 <- read.csv("D:/NTPU_class/case_studies/code/data_set/T6-2.csv", header = TRUE)
df_t62 <- df_t62[, -1]  # 去除第一欄，留下數據部分
# summary(df_t62)
# head(df_t62, 3)
```

<br> 


### > 1 - a. 請為這個製程建立 𝑋̅ 與 R 管制圖。請問製程是否在管制內?

```{r}
# 畫出 xbar 管制圖
q_xbar_t62 <- qcc(data = df_t62, type = "xbar")
# 畫出 R 管制圖
q_R_t62 <- qcc(data = df_t62, type = "R")
```


根據管制圖分析結果：

$\bar{X}$ 管制圖 中，各組樣本的平均值皆落於控制界限之間（LCL = -19.86，UCL = 41.52），無任何樣本超出界限，亦無持續遞增、遞減或其他異常圖形，顯示平均值變異穩定。

R 管制圖 中，各組樣本的全距亦均落於控制界限內（LCL = 0，UCL = 127.25），波動幅度無異常，未觀察到突波或趨勢性改變。

📌 結論：
該製程在平均值與波動範圍兩個面向皆未出現異常點或違規趨勢，顯示目前處於穩定狀態，可視為統計管制中，無須立即調整製程參數。

<br> 

### > 1 - b. 請為這個製程建立 𝑋̅ 與 S 管制圖。請問製程是否顯示在統計管制內?

```{r}
# 繪製 S 管制圖
q_S_t62 <- qcc(data = df_t62, type = "S")

# 顯示摘要資訊（可用來觀察上下界）
summary(q_S_t62)
```

根據 S 管制圖與摘要統計結果分析：

- 中心線（CL）= 25.23，代表樣本內標準差的平均值。
- 控制界線範圍為：LCL = 0，UCL = 52.71。
- 所有樣本的標準差皆落於控制界線之內，無樣本超出界限（Number beyond limits = 0）。
- 圖形未顯示任何趨勢性變化或明顯模式，顯示樣本內的變異情況穩定。

📌 **結論：**  
該製程的標準差變異屬於正常隨機波動，並無顯著異常或突波情況，搭配 $\bar{X}$ 與 R 圖結果可確定此製程目前處於 **統計管制狀態**。

<br>

### > 1 - c. 請使用全距法估計製程標準差。

```{r}
# 將資料轉為矩陣
cf <- as.matrix(df_t62)
# 計算每一組樣本的 R 值（最大值 - 最小值）
R <- apply(cf, 1, function(x) diff(range(x)))
# 計算 R 的平均值
R_bar <- mean(R)
# 查表值 d2，n=5 時為 2.326
d2 <- 2.326
# 用全距法估計標準差
sigma_hat <- R_bar / d2
sigma_hat
```

根據計算結果：

- 全距平均 $\bar{R} = 63.5$
- 查表係數 $d_2 = 2.326$（樣本大小 $n = 5$）

代入公式：

\[
\hat{\sigma} = \frac{\bar{R}}{d_2} = \frac{63.5}{2.326} = 27.30
\]

📌 **結論：**  
使用全距法估計的製程標準差約為 **27.30**。

<br>

### > 1 - d. 如果規格為名義值 ±100，請計算製程能力比率(process capability ratio, PCR), $C_p$

```{r}
# 上下規格界限
USL <- 100
LSL <- -100

# 製程能力比率公式
Cp <- (USL - LSL) / (6 * sigma_hat)
Cp
```

根據計算結果：

\[
C_p = \frac{USL - LSL}{6 \times \hat{\sigma}} = \frac{200}{6 \times 27.30} \approx 1.221
\]

📌 **結論：**  
此製程的能力比率 $C_p \approx 1.22$，**大於 1**，表示製程變異小於規格範圍，具備良好的製程能力，可滿足客戶要求。

> 備註：當 $C_p > 1$ 時，代表製程能力足夠；若 $C_p < 1$ 則代表製程變異太大，難以穩定在規格內。

<br>
### 🧾 第 1 題小總結：

透過 $\bar{X}$、R、S 管制圖與標準差估計分析，顯示製程波動穩定、無異常點。綜合 $C_p$ 值大於 1，也可推論該製程能力良好，具穩定控制與滿足規格的雙重優勢。


<br><hr>

##  [ 第2大題 ]

###  > 查看資料

```{r}
df_t63 <- read.csv("D:/NTPU_class/case_studies/code/data_set/T6-3.csv", header = TRUE)
df_t63 <- df_t63[, -1]  # 去除樣本編號欄，只留下觀測值
# summary(df_t63)
# head(df_t63, 3)
```

<br>

### > 2 - a. 請為這個製程建立 𝑋̅ 與 S 管制圖。請問製程是否顯示在統計管制內?如果有需要，請建構修改後的管制界線。

```{r}
# 畫出 xbar 與 S 管制圖
q2_xbar <- qcc(data = df_t63, type = "xbar")
q2_s <- qcc(data = df_t63, type = "S")

# 顯示摘要資訊
summary(q2_xbar)
summary(q2_s)
```

根據圖形與統計摘要結果可得：

- $\bar{X}$ 管制圖：
  - 中心線（CL）= -0.0033
  - 控制界線為 UCL = 0.9830，LCL = -0.9897
  - 所有樣本的平均值皆位於控制界線內，Number beyond limits = 0

- S 管制圖：
  - 中心線（CL）= 1.0662
  - 控制界線為 UCL = 1.8293，LCL = 0.3025
  - 所有樣本標準差也落在控制界線內，Number beyond limits = 0

📌 **結論：**  
瓶子填充高度的平均值與變異量皆穩定，製程目前處於統計管制狀態。

<br>

### > 2 - b. 請建立 R 管制圖，並且與 (a) 的 S 管制圖相比較。

```{r}
# 繪製 R 管制圖
q2_R <- qcc(data = df_t63, type = "R")
# 顯示摘要資訊（可選擇 echo = FALSE）
summary(q2_R)

```

根據 R 管制圖的結果：

- 中心線（CL）= 3.20
- 控制界線為 UCL = 5.69，LCL = 0.71
- 所有樣本的全距皆位於控制界線內，Number beyond limits = 0

📌 **結論：**  
R 管制圖與 (a) 的 S 管制圖結果一致，皆顯示製程變異穩定，無特殊異常樣本。

從實務上來看，當樣本數較大（如本題的 n=10），使用 S 管制圖會更能準確反映樣本內變異，因此在此情況下，**S 管制圖為較適合的變異分析工具**。

<br>

### > 2 - c. 請建立 $S^2$ 管制圖。


```{r}
# 設定參數
T1 <- 100  # 製程至少觀察時間（固定給 100）
p1 <- 0.05  # 顯著水準（通常用 5%）

# 建立 S² 管制圖
q2_s2 <- pbcc(data = df_t63, T1 = T1, p1 = p1, type = "S2")

# 顯示每個樣本的 S² 值、上下界
q2_s2$statistics
q2_s2$UCL
q2_s2$LCL

# 畫圖開始
options(scipen = 999)  # 避免科學記號
plot(
  q2_s2$statistics,
  type = "b",
  pch = 16,
  ylim = c(0, q2_s2$UCL[1] * 1.2),  # 強制包含 UCL
  ylab = "S²", xlab = "Sample"
)
abline(h = q2_s2$UCL[1], col = "red", lwd = 2)
abline(h = 0, col = "red", lwd = 2)
text(2, q2_s2$UCL[1] * 1.05, paste("UCL =", round(q2_s2$UCL[1], 5)))
text(2, -0.05, "LCL = 0")
```

根據繪製出的變異數管制圖可得：

- 上控制界限（UCL）= 4.20179
- 下控制界限（LCL）= 0.11078
- 所有樣本的變異數皆位於控制界線之內，無違規點

📌 **結論：**  
變異數在各樣本間波動穩定，無出現異常值，表示製程內部變異穩定、受控。  
搭配先前的 $\bar{X}$、S 與 R 管制圖結果，可確認本製程目前處於 **統計管制狀態**。

<br>

### 🧾 第 2 題小總結：

本題針對瓶子填充高度進行多角度製程分析，包括 $\bar{X}$、S、R、變異數等多種管制圖，皆未觀察到異常樣本或圖形。顯示此製程在平均值與變異量層面均穩定，屬於統計管制狀態。

<br><hr>

##  [ 第3大題 ]

###  > 查看資料

```{r}
# 載入 T6-4
df_t64 <- read.csv("D:/NTPU_class/case_studies/code/data_set/T6-4.csv", header = TRUE)
df_t64 <- df_t64[, -1]  # 移除 Sample 欄
# summary(df_t64)
# head(df_t64, 3)
# 載入 T6-5
df_t65 <- read.csv("D:/NTPU_class/case_studies/code/data_set/T6-5.csv", header = TRUE)
df_t65 <- df_t65[, -1]
# summary(df_t65)
# head(df_t65, 3)
```

<br>

### > 3 - a. 請建立 𝑥̅ 與 R 管制圖，並且檢查製程是否在管制內?

```{r}
q3_xbar <- qcc(data = df_t64, type = "xbar")
q3_R <- qcc(data = df_t64, type = "R")
summary(q3_xbar)
summary(q3_R)
```
根據繪製出的管制圖與摘要統計結果：

#### $\bar{X}$ 管制圖：
- 中心線（CL）= 130.881
- 控制界限為 UCL = 154.4491，LCL = 107.3129
- 雖然 **無資料點超出上下界限**，但出現兩個連續遞減或異常模式（Number violating runs = 2），顯示製程平均值可能存在非隨機變異。

#### R 管制圖：
- 中心線（CL）= 40.86
- 控制界限為 UCL = 86.3972，LCL = 0
- 所有樣本的全距皆在控制界限內，Number beyond limits = 0，波動無異常。

📌 **結論：**
從 $\bar{X}$ 圖中觀察到**連續異常模式**，雖未超界但需警覺潛在非隨機變異。  
搭配 R 圖判斷製程波動正常，建議進行進一步觀察或確認是否有特殊原因造成平均值偏移。

<br>

### > 3 - b. 在 (a) 建立管制圖之後，收集了 10 個新增分組資料如表 T6-5 所示，請將這些 𝑋̅ 與 R 值標繪於 (a) 的管制圖，並且提出結論。

```{r}
# 繪製加入新資料的管制圖
q3_xbar_new <- qcc(data = df_t64, type = "xbar", newdata = df_t65)
q3_R_new <- qcc(data = df_t64, type = "R", newdata = df_t65)

# 可額外加 summary 看異常點位置
summary(q3_xbar_new)
summary(q3_R_new)
```

將 10 組 T6-5 新樣本資料加入 $\bar{X}$ 與 R 管制圖後：

#### $\bar{X}$ 管制圖結果：
- 控制界限：UCL = 154.4491，LCL = 107.3129
- 所有新樣本皆**超出上控制界限**，共 10 筆異常（Number beyond limits = 10）
- 並且有連續異常趨勢出現（Number violating runs = 8）

#### R 管制圖結果：
- 控制界限：UCL = 86.3972，LCL = 0
- 新樣本的全距皆在界限內，無樣本超出控制界限

📌 **結論：**  
新資料在 $\bar{X}$ 管制圖中全部超出控制界限，顯示製程平均值發生重大偏移，可能導因於原料、機台或操作條件的改變。  
儘管 R 管制圖未見異常，仍應判定該製程已**不再處於統計管制狀態**，建議立即調查變異原因並重新建立新的控制界線。

<br>

### 🧾 第 3 題小總結：

初步觀測雖無超出界限點，但新資料加入後全數超出上控制界線，顯示製程平均值已大幅偏移。可推測製程已發生變異，應重新建構管制圖與界限以維持品質穩定。

<br><hr>

##  [ 第4大題 ]

###  > 查看資料

```{r}
# 載入 T6-6
df_t66 <- read.csv("D:/NTPU_class/case_studies/code/data_set/T6-6.csv", header = TRUE)
df_t66 <- df_t66[, -1]  # 移除 Sample 欄
# summary(df_t66)
# head(df_t66, 3)
```

<br>

### > 4 - a. 請建立個別觀察值管制圖。


```{r}
# 畫個別觀測值（I chart）
q4_xone <- qcc(data = df_t66, type = "xbar.one")
# 顯示摘要
summary(q4_xone)
```

根據繪製出的個別觀測值管制圖結果：

- 中心線（CL）= 16.1052  
- 上控制界限（UCL）= 16.1684  
- 下控制界限（LCL）= 16.0420  
- 所有觀測值皆落於控制界限之內  
- 無樣本超出界限（Number beyond limits = 0）  
- 無連續異常模式（Number violating runs = 0）

📌 **結論：**  
個別觀測值表現穩定，製程未出現明顯偏移或異常波動，故目前處於 **統計管制狀態**。

<br>

### > 4 - b. 請建立移動全距管制圖。

```{r}
# 建立移動全距（MR）資料
df_mr <- matrix(cbind(df_t66[-length(df_t66)], df_t66[-1]), ncol = 2)

# 畫出移動全距管制圖
q4_mr <- qcc(data = df_mr, type = "R")

# 顯示摘要
summary(q4_mr)
```

根據移動全距（Moving Range）管制圖結果如下：

- 中心線（CL）= 0.02375  
- 控制界限為 UCL = 0.07760，LCL = 0  
- 所有樣本的移動全距皆位於控制界限之內（Number beyond limits = 0）  
- 未觀察到連續異常趨勢（Number violating runs = 0）

📌 **結論：**  
移動全距波動穩定，未出現異常波動或突發性變異，表示個別觀測值之間的變化幅度均衡一致，製程變異處於統計管制之中。

<br>

### 🧾 第 4 題小總結：

透過 I chart 與 MR 管制圖雙重分析，無任何樣本超出控制界線或連續異常變化。表示該製程在個體表現與變異波動上皆具穩定性，適合使用 I-MR 管制圖作為日常監控依據。

<br><hr>


## 🎯 整體結論與建議：

本作業針對四組不同製程資料進行多種管制圖分析（$\bar{X}$、R、S、S²、I chart、MR），大部分製程呈現穩定，唯有第 3 題觀察到平均值偏移情況。建議持續以管制圖監控製程狀態，若觀察到連續異常圖形或跑出界線，應即時調查根本原因並採取改善措施。

若需進一步提升製程能力，可考慮進行中心化或減少內部變異，以使 $C_p$ 進一步提升。
