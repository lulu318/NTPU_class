---
title: "Chapter 6: Homework"
author: "711378912 蔡宜諠"
date: "2025/04/28"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---
## 作業：Seat-Belt Problem

### 實驗

Following is a sample of automobile accidents. The response categories are (1) not injured, (2) injured but not transported by emergency medical services, (3) injured and transported by emergency medical services but not hospitalized, (4) injured and hospitalized but did not die, (5) injured and died. Analyzed the data. Prepare a short report, summarizing your finding. Let SOI be the shorthand of severity of injury. 

|Gender|Location|Seat-Belt|SOI1|SOI2|SOI3|SOI4|SOI5|
|:----:|:------:|:-------:|---:|---:|---:|---:|---:|
|Female|Urban|No|7287|175|720|91|10|
| | |Yes|11587|126|577|48|8|
| |Rural|No|3246|73|710|159|31|
| | |Yes|6134|94|564|82|17|
|Male|Urban|No|10381|136|566|96|14|
| | |Yes|10969|83|259|37|1|
| |Rural|No|6123|141|710|188|45|
| | |Yes|6693|74|353|74|12|
### 核心問題

1. 我們關心的主要問題是Seat-Belt到底有沒有起到降低車禍傷害程度的作用？
2. 除了有無使用安全帶，是否還有其它影響結果的變量？Gender & Location

Note: 探索性實驗，Seat-Belt 必須留在最後的模型裡，而 Gender 及 Location 則不一定


<br>

### 資料
```{r}
gender <- rep(c("Female", "male"), each=4)
Location <- rep(rep(c("Urban", "Rural"), 2), each=2)
SB <- rep(c("No", "Yes"), 4)
SOI1 <- c(7287,11587,3246,6134,10381,10969,6123,6693)
SOI2 <- c(175,126,73,94,136,83,141,74)
SOI3 <- c(720,577,710,564,566,259,710,353)
SOI4 <- c(91,48,159,82,96,37,188,74)
SOI5 <- c(10,8,31,17,14,1,45,12)
DATA <- data.frame(gender, Location, SB, SOI1, SOI2, SOI3, SOI4, SOI5)
DATA
```

<hr>
```{r, message=FALSE}
# 載入需要的庫
library(ggplot2)
library(tidyr)
library(dplyr)
```

### 資料分析

#### 1. 繪圖呈現資料
 > Gender vs SOI
```{r}
# Gender vs SOI
Gender_SOI <- rbind(
  Female = colSums(DATA[DATA$gender == "Female", c("SOI1","SOI2","SOI3","SOI4","SOI5")]),
  Male   = colSums(DATA[DATA$gender == "male", c("SOI1","SOI2","SOI3","SOI4","SOI5")])
)
head(Gender_SOI)
```
```{r, fig.width=8, fig.height=7}
# 繪製馬賽克圖
mosaicplot(Gender_SOI, 
           main = " Gender vs SOI", 
           xlab = "Gender", 
           ylab = "SOI",
           color = TRUE,
           las = 1, 
           cex.axis = 0.8)
# 手動加入圖示 (legend)
legend("topright", inset=c(0.02, 0.1), fill=gray.colors(5), 
       legend=c("SOI1：Not injured",
                "SOI2：injured but not transported by emergency medical services",
                "SOI3：injured and transported by emergency medical services but not hospitalized,",
                "SOI4： injured and hospitalized but did not die,",
                "SOI5： injured and died. "), 
       cex=0.7, bg="white", box.col="black")
```

這張馬賽克圖看起來稍微可以水平的切開，有機會是顯著的。

```{r}
chisq_result <- chisq.test(Gender_SOI)
chisq_result
```
這個結果顯示沒有足夠證據證明 性別（Gender） 和 傷害程度（SOI） 之間不存在有顯著的統計關聯，因為 p-value 小於0.05。

<hr style="border-style: dashed; border-width: 2px; border-color: black;">

 > Location vs SOI

```{r}
# Location vs SOI
Location_SOI <- rbind(
  Urban = colSums(DATA[DATA$Location == "Urban", c("SOI1", "SOI2", "SOI3", "SOI4", "SOI5")]),
  Rural = colSums(DATA[DATA$Location == "Rural", c("SOI1", "SOI2", "SOI3", "SOI4", "SOI5")])
)
head(Location_SOI)
```
```{r, fig.width=8, fig.height=7}
# 繪製馬賽克圖
mosaicplot(Location_SOI, 
           main = "Location vs SOI", 
           xlab = "Location", 
           ylab = "SOI",
           color = TRUE,
           las = 1, 
           cex.axis = 0.8)

# 手動加入圖示 (legend)
legend("topright", inset=c(0.02, 0.1), fill=gray.colors(5), 
       legend=c("SOI1：Not injured",
                "SOI2：injured but not transported by emergency medical services",
                "SOI3：injured and transported by emergency medical services but not hospitalized",
                "SOI4：injured and hospitalized but did not die",
                "SOI5：injured and died"), 
       cex=0.7, bg="white", box.col="black")
```

這張馬賽克圖看起來稍微可以水平的切開，有機會是顯著的。

```{r}
# 進行卡方檢定
chisq_result <- chisq.test(Location_SOI)
chisq_result
```

這個結果顯示沒有足夠證據證明 地點（Location） 和 傷害程度（SOI） 之間不存在有顯著的統計關聯，因為 p-value 小於0.05。

<hr style="border-style: dashed; border-width: 2px; border-color: black;">

 > Seat-Belt vs SOI

```{r}
# Seat-Belt vs SOI
SB_SOI <- rbind(
  Yes = colSums(DATA[DATA$SB == "Yes", c("SOI1", "SOI2", "SOI3", "SOI4", "SOI5")]),
  No = colSums(DATA[DATA$SB == "No", c("SOI1", "SOI2", "SOI3", "SOI4", "SOI5")])
)
head(SB_SOI)
```


```{r, fig.width=8, fig.height=7}
# 繪製馬賽克圖
mosaicplot(SB_SOI, 
           main = "Seat-Belt vs SOI", 
           xlab = "Seat-Belt", 
           ylab = "SOI",
           color = TRUE,
           las = 1, 
           cex.axis = 0.8)

# 手動加入圖示 (legend)
legend("topright", inset=c(0.02, 0.1), fill=gray.colors(5), 
       legend=c("SOI1：Not injured",
                "SOI2：injured but not transported by emergency medical services",
                "SOI3：injured and transported by emergency medical services but not hospitalized",
                "SOI4：injured and hospitalized but did not die",
                "SOI5：injured and died"), 
       cex=0.7, bg="white", box.col="black")
```

這張馬賽克圖看起來稍微可以水平的切開，有機會是顯著的。

```{r}
chisq_result <- chisq.test(SB_SOI)
chisq_result
```

這個結果顯示沒有足夠證據證明 是否繫安全帶（Seat-Belt） 和 傷害程度（SOI） 之間不存在有顯著的統計關聯，因為 p-value 小於0.05。

<br><hr>

  
#### 2. 模型建立與統計分析

```{r, message=FALSE}
library(VGAM)
# 建立多類別邏輯回歸模型
# 使用 Parallel Logit Model
fit_full_par <- vglm(cbind(SOI1, SOI2, SOI3, SOI4, SOI5) ~ gender * Location * SB,   # 星星表示把交互作用一起放進去 
                     family = cumulative(parallel = TRUE),
                     data = DATA)
summary(fit_full_par)
```

含交互作用模型 [ 性別、地點與是否佩戴安全帶對傷害程度的影響 ]： 

1. 性別、地點 和 是否佩戴安全帶 都顯示對 傷害程度（SOI） 有顯著影響。

2. 性別與地點的交互作用 顯示顯著（p-value = 0.0151），應該保留在模型中。

3. 其他的交互作用項（如 gender:LocationUrban:SByes）則不顯著，可以考慮移除。

4. Hauck-Donner effect 顯示模型中某些類別的估計可能存在問題，需進一步檢查。

總體來說，這個模型顯示了性別、地點和是否佩戴安全帶對傷害程度的顯著影響，並且性別與地點的交互作用也應納入分析。**( 這裡回答了第二個問題~ )**

```{r, message=FALSE}
# 建立多類別邏輯回歸模型
# 非平行邏輯回歸模型
fit_full_nonpar <- vglm(cbind(SOI1, SOI2, SOI3, SOI4, SOI5) ~ gender * Location * SB,   # 星星表示把交互作用一起放進去 
                     family = cumulative(parallel = FALSE),    # Parallel = true 斜率共用 
                     data = DATA)
summary(fit_full_nonpar)
```


```{r}
# 建立不包含交互作用項的模型
fit_red_par <- vglm(cbind(SOI1, SOI2, SOI3, SOI4, SOI5) ~ gender + Location + SB, 
                    family = cumulative(parallel = TRUE), 
                    data = DATA)
summary(fit_red_par)
```

無交互作用模型 [ 性別、地點（Urban/Rural）和 是否佩戴安全帶（SB）對 傷害程度（SOI） 的影響 ]：

1. 性別、地點 和 是否佩戴安全帶 對 傷害程度（SOI）都有顯著影響（p-value < 0.05）。

   - 性別（gendermale）顯示出顯著性，顯示男性與女性在傷害程度上的分佈有差異。

   - 地點（LocationUrban）顯示出顯著性，顯示城市與鄉村的傷害程度有差異。

   - 是否佩戴安全帶（SBYes）也顯示出顯著性，表明佩戴安全帶對傷害程度有顯著影響。

2. 交互作用：結果中未顯示交互作用項（如 gender:LocationUrban）有顯著性，因此可以認為這些變數的影響是獨立的。

3. Hauck-Donner效應：模型中警告顯示 (Intercept):3 和 (Intercept):4 存在 Hauck-Donner效應，這通常指的是這些參數的估計可能不穩定，可能需要進一步檢查。



 > Discuss that which model should be applied (use parallel model?)

```{r}
# 進行偏差檢驗
LRT <- deviance(fit_full_nonpar) - deviance(fit_full_par)
pvalue <- 1 - pchisq(LRT, df = 1)
cat("比較是否要使用Parallel Logit Model: LRT =", LRT, ", p-value =", pvalue, "\n")
```

從這個結果來看，LRT = -151.0362 和 p-value = 1 表示 parallel = TRUE 和 parallel = FALSE 兩個模型之間沒有顯著區別。這意味著 Proportional Odds 成立，因此 Parallel Logit Model 是合適的。

<hr style="border-style: dashed; border-width: 2px; border-color: black;">

 > Determine whether gender and location should be involved in the model

是的，性別 和 地點 應該納入模型中，因為這些變數對 SOI 顯示出顯著影響（p-value 小於 0.05）。

<hr style="border-style: dashed; border-width: 2px; border-color: black;">

 > Any interaction?


```{r}
# 進行卡方檢定，檢查交互作用項是否顯著
LRT <- deviance(fit_red_par) - deviance(fit_full_par)
pvalue <- 1 - pchisq(LRT, df = 1)

cat("比較是否使用有交互作用模型: LRT =", LRT, ", p-value =", pvalue, "\n")
```

這表示在比較 有交互作用項模型 和 無交互作用項模型 時，卡方檢定的 p-value 小於 0.05，這意味著 交互作用項是顯著的。
結論： 由於 p-value = 0.0034 小於 0.05，我們可以 拒絕零假設（即交互作用項無顯著性），並得出結論：交互作用項對模型有顯著影響，因此應該保留交互作用項。


<br><hr>

#### 3. 結論
 > Report your final model and explain the meaning of parameters.

最終選擇的模型是 Cumulative Logit Model，並使用 Parallel Logit Model 假設，因為 SOI 是順序型資料，且Proportional Odds成立。

1. 模型解釋：

   - 性別（gender）：顯示出顯著性（p-value < 0.05），表示性別對 傷害程度（SOI） 有顯著影響，男性和女性在不同傷害程度的分佈上有所區別。

   - 地點（Location）：也顯示顯著性（p-value < 0.05），顯示城市與鄉村的傷害程度有顯著差異。

   - 是否佩戴安全帶（SB）：顯示顯著性（p-value < 0.05），表明佩戴安全帶與傷害程度之間有顯著關聯。

2. 交互作用：

    性別與地點的交互作用（gender:Location） 顯示顯著（p-value = 0.0151），表明性別和地點之間的交互作用對 SOI 產生影響。這意味著不同性別在不同地點的傷害程度有所不同。

3. 模型的參數解釋：

   - 截距項（Intercept）：對每一類別（SOI1、SOI2、SOI3、SOI4）的基準概率進行估計。

   - 性別（gender）：男性相對於女性的傷害程度變化。gendermale 的正值意味著男性的某些傷害程度的概率較高。

   - 地點（Location）：城市地區與鄉村地區在傷害程度上的差異。LocationUrban 的正值表示城市地區的傷害程度較高。

   - 是否佩戴安全帶（SB）：佩戴安全帶對傷害程度的影響。SBYes 的正值表示佩戴安全帶有助於減少傷害。

4. 模型檢驗：

   卡方檢定結果顯示 交互作用項 顯示顯著（p-value = 0.0034），因此 可以拒絕H0（即交互作用項無顯著性）。這進一步支持了保留交互作用項的結論，也證明了 Parallel Logit Model 是合適的。

